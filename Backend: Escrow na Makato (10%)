// backend/functions/src/index.ts
import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

export const malipoYaKazi = functions.https.onCall(async (data, context) => {
    // Hakikisha aliyebonyeza amelogin
    if (!context.auth) throw new functions.https.HttpsError('unauthenticated', 'Lazima uwe umeingia');

    const { jobId } = data;
    const jobRef = admin.firestore().collection('jobs').doc(jobId);
    const snap = await jobRef.get();
    const jobData = snap.data();

    if (jobData?.status === 'COMPLETED') {
        const jumla = jobData.amount;
        const chakoFundi = jumla * 0.90; // 90% kwa fundi
        const chakoApp = jumla * 0.10;   // 10% kwa Fundy App

        const batch = admin.firestore().batch();

        // 1. Ongeza pesa kwenye pochi ya fundi
        const fundiWallet = admin.firestore().collection('wallets').doc(jobData.fundiId);
        batch.set(fundiWallet, { 
            balance: admin.firestore.FieldValue.increment(chakoFundi) 
        }, { merge: true });

        // 2. Rekodi mapato ya kampuni
        const revenueRef = admin.firestore().collection('revenue').doc();
        batch.set(revenueRef, { amount: chakoApp, date: new Date() });

        await batch.commit();
        return { message: "Malipo yamekamilika kikamilifu!" };
    }
});
